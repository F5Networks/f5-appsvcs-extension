# Adding New Mappings

## Relevant Files
### src/nodejs
<dl>
    <dt>paths.json</dt>
        <dd>
        Contains a list of iControl REST URLs to use to gather the BIG-IP state.
        </dd>
    <dt>properties.json</dt>
        <dd>
        Describes configuration objects and their properties.
        Many simple mappings can be handled here, such as differences in property names between AS3 and MCP.
        </dd>
    <dt>map_as3.js</dt>
        <dd>
        Maps the user declaration to the normalized format.
        </dd>
    <dt>map_cli.js</dt>
        <dd>
        Maps the normalized format to a tmsh script.
        </dd>
    <dt>map_mcp.js</dt>
        <dd>
        Maps the result of iControl REST calls to the normalized format.
        </dd>
</dl>
### src/schema
<dl>
    <dt>adc-schema.json</dt>
        <dd>
        Output file from building the schema.
        Do not edit this file directly!
        </dd>
    <dt>core-schema.json</dt>
        <dd>
        The base schema file that gets modified to produce adc-schema.json.
        </dd>
    <dt>def-*-schema.json</dt>
        <dd>
        Schema definitions that have been pulled out of core-schema.json and put into their own files.
        These definitions are added to core-schema.json to create adc-schema.json when building the schema.
        </dd>
    <dt>pointers.json</dt>
        <dd>
        Parameters for generating def-pointers-schema.json.
        </dd>
</dl>

## Suggested Workflow
1. **Update schema**.
If schema does not exist for the feature, that should be created first.
Any schema additions and modifications should be carefully reviewed since it is important to get it right up front.
After updating schema files, run `scripts/build/schema-build.js` to generate `adc-schema.json` (this is done automatically during the build process).
2. **Create test case**.
In order to test your changes, you will need a declaration that makes use of them.
This declaration will be send as a POST request to the `/mgmt/shared/appsvcs/declare` endpoint.
There are many good examples of test declarations in the `selftest_examples` directory.
It is helpful to enable trace files and debug output in the test declaration using the `control` property.
3. **Update AS3 mappings**.
Here is where you start making code changes.
In this step, focus on getting the BIG-IP to match your declaration one property at a time.
To add a new AS3 class, you will need to add it to `properties.json` and `map_as3.js`.
New classes are added to `map_as3.js` by adding them to the `translate` object.
The keys of the `translate` object are AS3 class names (found in the schema), and the values are functions that transform the class declaration into the normalized format.
To add a property, first add it to `properties.json`.
If the property needs more than the basic mappings that `properties.json` can handle, you will need to add code to `map_as3.js`.
4. **Make sure the test case can be deleted**.
Once your declaration can be successfully applied to a BIG-IP, it is a good time to make sure deleting works as expected by sending a DELETE request to the `/mgmt/shared/appsvcs/declare` endpoint.
Many properties and classes will delete properly without further code changes.
Certain features do not work properly with tmsh transactions, and will require extra handling in `fetch.js` and `map_cli.js`.
5. **Update MCP mappings**.
It is important that a second POST request to the `/mgmt/shared/appsvcs/declare` endpoint results in a "no change" result.
For that to happen, AS3 needs to be able to properly read the BIG-IP state to produce a normalized configuration that matches the one created by normalizing the user declaration.
Start by adding any new iControl REST endpoints to `paths.json`.
To get the iControl REST object translated to a normalized configuration, you will need to update the `translate` object in `map_mcp.js`.
The keys in the `translate` object are the kind values from the iControl REST objects, and the values are functions that translate the iControl REST object to a normalized configuration object.
6. **Update tests**.
To make sure your new features continue to work, update the related property tests in the `test/integration/bigip` directory.
